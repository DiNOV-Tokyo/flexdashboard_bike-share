---
title: "Share bike in Portland"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
    source_code: embed
---

```{r setup, include=FALSE}
# https://github.com/simonpcouch/gbfs
library(flexdashboard)
library(gbfs)
library(tidyverse)
library(leaflet)
library(crosstalk)  # inter-widget interactivity
library(DT)  # interactive tables

# -------------- Data ------------------
pdx_station_info <- 
  get_station_information("https://gbfs.biketownpdx.com/gbfs/gbfs.json")

pdx_station_status <- 
  get_station_status("https://gbfs.biketownpdx.com/gbfs/gbfs.json")

pdx_stations <- full_join(pdx_station_info, 
                          pdx_station_status, 
                          by = "station_id") %>%
  select(id = station_id, 
         lon, 
         lat, 
         num_bikes_available, 
         num_docks_available) %>%
  mutate(type = "docked")

pdx_free_bikes <- 
  get_free_bike_status("https://gbfs.biketownpdx.com/gbfs/gbfs.json", 
                       output = "return") %>%
  select(id = bike_id, lon, lat) %>%
  mutate(num_bikes_available = 1,
         num_docks_available = NA,
         type = "free")

pdx_full <- bind_rows(pdx_stations, pdx_free_bikes)


```



Sidebar {.sidebar data-width=300} 
-----------------------------------------------------------------------

### Filters

```{r}

showcase_df <- data.frame(c("A", "B", "A", "B", "A", "B"), c(1,5,3,2,4,1))
colnames(showcase_df) <- c("category", "costs")
shared_data <- SharedData$new(pdx_full)

filter_select("showcase_filter", "A or B?", shared_data, showcase_df$category)

valueBox(sum(pdx_full$num_bikes_available))

bscols(
  filter_checkbox(
    id = "bike_type",
    label = "Bikes type",
    sharedData = shared_data,
    group = ~pdx_full$type
  ),
  filter_slider(
    id = "docks_available",
    label = "Available docs",
    sharedData = shared_data,
    column = ~pdx_full$num_docks_available,
    step = 10,
    round = TRUE,
    sep = "",
    ticks = FALSE
  )
)

```

Row
-----------------------------------------------------------------------

### confirmed {.value-box}

```{r}

valueBox(value = sum(pdx_stations$num_docks_available), 
         caption = "Total number of docks available nearby", 
         #icon = "fas fa-user-md", 
         color = "green")
```

### Number_Bike {.value-box}

```{r}

valueBox(value = sum(pdx_stations$num_bikes_available), 
         caption = "Total number of bike available", 
         #icon = "fas fa-user-md", 
         color = "blue")
```


Row
-----------------------------------------------------------------------


### Interactive map

```{r}
leaflet(pdx_full) %>% 
  addTiles() %>% 
  addCircleMarkers(lng=~lon,lat=~lat, radius = ~num_bikes_available, color="blue", weight=2) %>% 
  addCircleMarkers(lng=~lon,lat=~lat, radius = ~num_docks_available, color="red", weight=2) %>% 
  addAwesomeMarkers(
    icon = awesomeIcons(
      library = "ion",
      icon = ifelse(
        test = pdx_full$type == "free",
        yes = "ion-android-star-outline",
        no = "ion-android-radio-button-off"
      ),
      iconColor = "white",
      markerColor = ifelse(
        test = pdx_full$type == "Type", 
        yes = "orange",
        no = "green"
      )
    )
  )
```



Row
-----------------------------------------------------------------------


### Datatable
    
```{r datatable}

pdx_full %>% 
  DT::datatable(   
    filter = "top",  # allows filtering on each column
    rownames = FALSE,  # remove rownames
    style = "bootstrap",
    class = "compact",
    width = "100%",
    colnames = c(
     "ID" = "id",
     "Lon" = "lon",
     "Lat" = "lat",
     "Num_Bikes" = "num_bikes_available",
     "Num_Docks" = "num_docks_available",
     "Type" = "type"
   )
  )
  
```
